name: Publish to DEV.to

on:
  push:
    branches: [main]
    paths:
      - 'devto/**/*.md'
      - '.github/workflows/publish-to-devto.yml'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Publish articles to DEV.to
        env:
          DEVTO_API_KEY: ${{ secrets.DEV_TO_API_KEY }}
        run: |
          # Fetch all existing articles (published + unpublished/drafts)
          published=$(curl -s "https://dev.to/api/articles/me?per_page=100" \
            -H "api-key: $DEVTO_API_KEY")
          unpublished=$(curl -s "https://dev.to/api/articles/me/unpublished?per_page=100" \
            -H "api-key: $DEVTO_API_KEY")
          existing=$(echo "$published $unpublished" | jq -s 'add')

          for file in devto/*.md; do
            echo "=== Processing $file ==="

            # Extract frontmatter fields (strip optional surrounding quotes)
            title=$(sed -n 's/^title: *//p' "$file" | sed 's/^"//; s/"$//')
            description=$(sed -n 's/^description: *//p' "$file" | sed 's/^"//; s/"$//')
            tags=$(sed -n 's/^tags: *//p' "$file")
            canonical_url=$(sed -n 's/^canonical_url: *//p' "$file")
            cover_image=$(sed -n 's/^cover_image: *//p' "$file")
            published_raw=$(sed -n 's/^published: *//p' "$file")
            published=$([ "$published_raw" = "false" ] && echo "false" || echo "true")

            # Extract body: skip lines until second '---', then print the rest
            body=$(awk 'BEGIN{n=0} /^---$/{n++; next} n>=2{print}' "$file")

            if [ -z "$body" ]; then
              echo "  Warning: empty body, skipping"
              continue
            fi

            # Check if article with same title already exists
            article_id=$(echo "$existing" | jq -r --arg t "$title" \
              '.[] | select(.title == $t) | .id // empty')

            # Build JSON payload
            json_payload=$(jq -n \
              --arg title "$title" \
              --arg body "$body" \
              --arg description "$description" \
              --arg tags "$tags" \
              --arg canonical "$canonical_url" \
              --arg cover "$cover_image" \
              --arg published "$published" \
              '{article: {
                title: $title,
                body_markdown: $body,
                description: $description,
                tags: ($tags | split(", ")),
                canonical_url: (if $canonical != "" then $canonical else null end),
                cover_image: (if $cover != "" then $cover else null end),
                published: ($published == "true")
              }}')

            if [ -n "$article_id" ]; then
              # Update existing article
              echo "  Updating existing article (id: $article_id)"
              response=$(curl -s -w "\n__HTTP_STATUS__:%{http_code}" -X PUT "https://dev.to/api/articles/$article_id" \
                -H "Content-Type: application/json" \
                -H "api-key: $DEVTO_API_KEY" \
                -d "$json_payload")
              sleep 5  # Rate limit: avoid 429 on consecutive updates
            else
              # Create new article
              echo "  Creating new article"
              response=$(curl -s -w "\n__HTTP_STATUS__:%{http_code}" -X POST "https://dev.to/api/articles" \
                -H "Content-Type: application/json" \
                -H "api-key: $DEVTO_API_KEY" \
                -d "$json_payload")
              sleep 30  # Rate limit: stricter for new article creation
            fi

            # Extract HTTP status code and body
            http_status=$(echo "$response" | grep "__HTTP_STATUS__:" | sed 's/.*__HTTP_STATUS__://')
            response_body=$(echo "$response" | grep -v "__HTTP_STATUS__:")
            echo "  HTTP Status: $http_status"
            echo "  Raw response: $response_body"

            # Show result
            echo "  Result: $(echo "$response_body" | jq -r '.url // .error // "unknown"' 2>&1)"

          done
